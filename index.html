// Codice da aggiungere alla tua pagina GitHub Pages (index.html)
// Sostituisci o aggiorna il JavaScript esistente con questo

document.addEventListener('DOMContentLoaded', function() {
    console.log('üç¥ Hungry Tickets GitHub Pages caricata');
    
    // Ottieni parametri URL
    const urlParams = new URLSearchParams(window.location.search);
    
    // Supporta tutti i formati di link
    const serviceId = urlParams.get('p');      // Servizio esterno: ?p=abc123
    const hashId = urlParams.get('h');         // Hash locale: ?h=x7k9m2n1  
    const microData = urlParams.get('m');      // Micro link: ?m=eyJuIjoi...
    const legacyData = urlParams.get('d') || urlParams.get('data'); // Legacy: ?d= o ?data=
    
    // Mostra stato iniziale
    updateStatus('Analizzando tipo di link...', 'info');
    
    if (serviceId) {
        console.log('üåê Rilevato link servizio esterno');
        handleServiceLink(serviceId);
    } else if (hashId) {
        console.log('üîó Rilevato link hash locale');
        handleHashLink(hashId);
    } else if (microData) {
        console.log('üî¨ Rilevato micro-link');
        handleMicroLink(microData);
    } else if (legacyData) {
        console.log('üìú Rilevato link legacy');
        handleLegacyLink(legacyData);
    } else {
        updateStatus('‚ùå Nessun dato cookie trovato nell\'URL', 'error');
        showInstructions();
    }
});

// Gestisce link da servizio esterno (dpaste.com)
async function handleServiceLink(serviceId) {
    updateStatus('üåê Caricamento da servizio esterno...', 'info');
    
    try {
        // Prova diverse varianti URL per dpaste
        const urls = [
            `https://dpaste.com/${serviceId}.txt`,
            `https://dpaste.com/${serviceId}/raw`,
            `https://dpaste.com/${serviceId}`
        ];
        
        let data = null;
        
        for (const url of urls) {
            try {
                console.log(`Tentativo caricamento: ${url}`);
                const response = await fetch(url);
                
                if (response.ok) {
                    const text = await response.text();
                    console.log('Risposta ricevuta:', text.substring(0, 100) + '...');
                    
                    // Prova a parsare come JSON
                    try {
                        data = JSON.parse(text);
                        console.log('‚úÖ Dati JSON caricati con successo');
                        break;
                    } catch (e) {
                        console.log('Non √® JSON valido, provo URL successivo...');
                    }
                }
            } catch (e) {
                console.log(`Errore caricamento ${url}:`, e.message);
            }
        }
        
        if (data) {
            await processUnifiedData(data);
        } else {
            throw new Error('Impossibile caricare i dati dal servizio esterno');
        }
        
    } catch (error) {
        console.error('‚ùå Errore servizio esterno:', error);
        updateStatus('‚ùå Errore caricamento servizio - link scaduto o non valido', 'error');
        showFallbackInstructions();
    }
}

// Gestisce link hash locale
async function handleHashLink(hashId) {
    updateStatus('üîó Caricamento da hash locale...', 'info');
    
    try {
        const dataString = localStorage.getItem(`ht_${hashId}`);
        
        if (dataString) {
            const data = JSON.parse(dataString);
            console.log('‚úÖ Dati hash caricati da localStorage');
            await processUnifiedData(data);
        } else {
            throw new Error('Hash non trovato in localStorage');
        }
        
    } catch (error) {
        console.error('‚ùå Errore hash locale:', error);
        updateStatus('‚ùå Hash non trovato - rigenera il link dall\'estensione', 'error');
        showFallbackInstructions();
    }
}

// Gestisce micro-link
async function handleMicroLink(microData) {
    updateStatus('üî¨ Decodifica micro-link...', 'info');
    
    try {
        const decoded = JSON.parse(atob(microData));
        console.log('Micro-dati decodificati:', decoded);
        
        const data = {
            cookies: [{
                name: decoded.n,
                value: decoded.v,
                domain: decoded.d.includes('.') ? decoded.d : '.ticketone.it',
                path: '/',
                secure: false,
                httpOnly: false
            }],
            url: 'https://sport.ticketone.it',
            timestamp: decoded.t * 60000,
            source: 'micro-link'
        };
        
        console.log('‚úÖ Micro-link decodificato con successo');
        await processUnifiedData(data);
        
    } catch (error) {
        console.error('‚ùå Errore micro-link:', error);
        updateStatus('‚ùå Errore decodifica micro-link - formato non valido', 'error');
        showFallbackInstructions();
    }
}

// Gestisce link legacy (formato originale)
async function handleLegacyLink(legacyData) {
    updateStatus('üìú Decodifica link legacy...', 'info');
    
    try {
        const jsonString = atob(legacyData);
        const compressedData = JSON.parse(jsonString);
        
        // Converte formato legacy a formato unificato
        const data = {
            cookies: compressedData.c.map(c => ({
                name: c.n,
                value: c.v,
                domain: c.d,
                path: c.p || '/',
                secure: c.s === 1,
                httpOnly: c.h === 1
            })),
            url: compressedData.u,
            timestamp: compressedData.t,
            source: `legacy-v${compressedData.v || 3}`
        };
        
        console.log('‚úÖ Link legacy decodificato con successo');
        await processUnifiedData(data);
        
    } catch (error) {
        console.error('‚ùå Errore link legacy:', error);
        updateStatus('‚ùå Errore decodifica link legacy', 'error');
        showFallbackInstructions();
    }
}

// Processore unificato per tutti i formati
async function processUnifiedData(data) {
    console.log('üç™ Processando dati unificati:', data);
    
    if (!data.cookies || !Array.isArray(data.cookies)) {
        throw new Error('Formato dati non valido');
    }
    
    updateStatus(`üç™ Trovati ${data.cookies.length} cookie - Preparazione iniezione...`, 'info');
    
    // Simula il processo di iniezione (la logica reale √® nell'estensione)
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    updateStatus('‚úÖ Cookie pronti per l\'iniezione!', 'success');
    
    // Mostra dettagli
    showCookieDetails(data);
    
    // Auto-redirect se presente URL
    if (data.url) {
        updateStatus('üöÄ Reindirizzamento a Ticketone in 3 secondi...', 'info');
        setTimeout(() => {
            window.location.href = data.url;
        }, 3000);
    }
}

// Mostra dettagli cookie
function showCookieDetails(data) {
    const details = document.getElementById('cookie-details') || createDetailsElement();
    
    let html = `
        <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
            <h3 style="color: #ffed4e; margin-bottom: 10px;">üìä Dettagli Cookie</h3>
            <p><strong>Cookie trovati:</strong> ${data.cookies.length}</p>
            <p><strong>Timestamp:</strong> ${new Date(data.timestamp).toLocaleString()}</p>
            <p><strong>Fonte:</strong> ${data.source || 'sconosciuta'}</p>
            
            <div style="margin-top: 15px;">
                <h4 style="color: #ffed4e;">Cookie:</h4>
                <ul style="margin: 5px 0; padding-left: 20px;">
    `;
    
    data.cookies.forEach(cookie => {
        const shortValue = cookie.value.length > 50 ? 
            cookie.value.substring(0, 50) + '...' : 
            cookie.value;
        html += `<li><strong>${cookie.name}:</strong> ${shortValue}</li>`;
    });
    
    html += `
                </ul>
            </div>
        </div>
    `;
    
    details.innerHTML = html;
}

// Crea elemento dettagli se non esiste
function createDetailsElement() {
    const details = document.createElement('div');
    details.id = 'cookie-details';
    details.style.maxWidth = '600px';
    details.style.margin = '0 auto';
    
    const container = document.querySelector('.container') || document.body;
    container.appendChild(details);
    
    return details;
}

// Aggiorna status nella pagina
function updateStatus(message, type = 'info') {
    console.log(`Status [${type}]: ${message}`);
    
    // Trova o crea elemento status
    let statusEl = document.getElementById('status-message');
    if (!statusEl) {
        statusEl = document.createElement('div');
        statusEl.id = 'status-message';
        statusEl.style.maxWidth = '600px';
        statusEl.style.margin = '20px auto';
        statusEl.style.padding = '15px';
        statusEl.style.borderRadius = '8px';
        statusEl.style.textAlign = 'center';
        statusEl.style.fontWeight = 'bold';
        
        const container = document.querySelector('.container') || document.body;
        container.appendChild(statusEl);
    }
    
    // Colori in base al tipo
    const colors = {
        'info': 'background: rgba(23, 162, 184, 0.2); color: #17a2b8; border: 1px solid #17a2b8;',
        'success': 'background: rgba(40, 167, 69, 0.2); color: #28a745; border: 1px solid #28a745;',
        'error': 'background: rgba(220, 53, 69, 0.2); color: #dc3545; border: 1px solid #dc3545;',
        'warning': 'background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid #ffc107;'
    };
    
    statusEl.style.cssText += colors[type] || colors.info;
    statusEl.textContent = message;
}

// Mostra istruzioni di base
function showInstructions() {
    updateStatus('‚ÑπÔ∏è Per usare questa pagina, apri un link generato dall\'estensione Hungry Tickets', 'info');
    
    const instructions = `
        <div style="margin: 30px auto; max-width: 600px; text-align: left;">
            <h3 style="color: #ffed4e;">üìñ Come Funziona:</h3>
            <ol style="color: rgba(255,255,255,0.9); line-height: 1.6;">
                <li>Installa l'estensione Hungry Tickets</li>
                <li>Vai su Ticketone e fai login</li>
                <li>Usa l'estensione per generare un link</li>
                <li>Apri il link generato (arriverai qui automaticamente)</li>
                <li>I cookie verranno caricati automaticamente</li>
            </ol>
        </div>
    `;
    
    const container = document.querySelector('.container') || document.body;
    container.innerHTML += instructions;
}

// Mostra istruzioni di fallback
function showFallbackInstructions() {
    const fallback = `
        <div style="margin: 20px auto; max-width: 600px; padding: 15px; background: rgba(255,193,7,0.1); border: 1px solid #ffc107; border-radius: 8px;">
            <h4 style="color: #ffc107;">üîß Soluzioni Alternative:</h4>
            <ul style="color: rgba(255,255,255,0.9); line-height: 1.6;">
                <li><strong>Link scaduto:</strong> Rigenera un nuovo link dall'estensione</li>
                <li><strong>Hash locale:</strong> Usa lo stesso browser dove hai generato il link</li>
                <li><strong>Servizio esterno:</strong> Prova a rigenerare se il servizio √® temporaneamente non disponibile</li>
                <li><strong>Link danneggiato:</strong> Controlla che il link sia stato copiato completamente</li>
            </ul>
        </div>
    `;
    
    const container = document.querySelector('.container') || document.body;
    container.innerHTML += fallback;
}
