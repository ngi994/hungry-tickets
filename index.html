// CODICE CORRETTO per la pagina GitHub Pages
// Sostituisci TUTTO il JavaScript esistente con questo

document.addEventListener('DOMContentLoaded', function() {
    console.log('üç¥ Hungry Tickets GitHub Pages caricata');
    
    // Mostra status iniziale
    updateStatus('Analizzando link...', 'info');
    
    // Ottieni parametri URL
    const urlParams = new URLSearchParams(window.location.search);
    
    // Supporta tutti i formati
    const microData = urlParams.get('m');      // Micro link: ?m=eyJuIjoi...
    const legacyData = urlParams.get('d') || urlParams.get('data'); // Legacy: ?d= o ?data=
    
    if (microData) {
        console.log('üî¨ Rilevato micro-link');
        handleMicroLink(microData);
    } else if (legacyData) {
        console.log('üìú Rilevato link legacy');
        handleLegacyLink(legacyData);
    } else {
        updateStatus('‚ùå Nessun dato cookie trovato nell\'URL', 'error');
        showInstructions();
    }
});

// Gestisce micro-link - VERSIONE CORRETTA
async function handleMicroLink(microData) {
    updateStatus('üî¨ Decodifica micro-link...', 'info');
    
    try {
        console.log('Raw microData:', microData.substring(0, 100) + '...');
        
        // IMPORTANTE: Decodifica URL prima di Base64
        const urlDecoded = decodeURIComponent(microData);
        console.log('URL decoded length:', urlDecoded.length);
        
        // Poi decodifica Base64
        const jsonString = atob(urlDecoded);
        console.log('Base64 decoded length:', jsonString.length);
        
        // Infine parse JSON
        const decoded = JSON.parse(jsonString);
        console.log('JSON parsed, cookie count:', decoded.c.length);
        
        // Converte formato micro a formato standard
        const data = {
            cookies: decoded.c.map(c => ({
                name: c.n,
                value: c.v,
                domain: c.d === 'main' ? '.ticketone.it' : 
                        c.d === 'sport' ? 'sport.ticketone.it' :
                        c.d.includes('.') ? c.d : c.d + '.ticketone.it',
                path: '/',
                secure: false,
                httpOnly: false
            })),
            url: decoded.u || 'https://sport.ticketone.it',
            timestamp: decoded.t ? decoded.t * 60000 : Date.now(),
            source: `micro-v${decoded.v || 5}`
        };
        
        console.log('‚úÖ Micro-link decodificato con successo');
        await processUnifiedData(data);
        
    } catch (error) {
        console.error('‚ùå Errore micro-link:', error);
        updateStatus('‚ùå Errore decodifica micro-link - ' + error.message, 'error');
        showFallbackInstructions();
    }
}

// Gestisce link legacy
async function handleLegacyLink(legacyData) {
    updateStatus('üìú Decodifica link legacy...', 'info');
    
    try {
        const jsonString = atob(legacyData);
        const compressedData = JSON.parse(jsonString);
        
        const data = {
            cookies: compressedData.c.map(c => ({
                name: c.n,
                value: c.v,
                domain: c.d,
                path: c.p || '/',
                secure: c.s === 1,
                httpOnly: c.h === 1
            })),
            url: compressedData.u,
            timestamp: compressedData.t * 1000,
            source: `legacy-v${compressedData.v || 3}`
        };
        
        console.log('‚úÖ Link legacy decodificato con successo');
        await processUnifiedData(data);
        
    } catch (error) {
        console.error('‚ùå Errore link legacy:', error);
        updateStatus('‚ùå Errore decodifica link legacy - ' + error.message, 'error');
        showFallbackInstructions();
    }
}

// Processore unificato
async function processUnifiedData(data) {
    console.log('üç™ Processando dati:', data);
    
    if (!data.cookies || !Array.isArray(data.cookies)) {
        throw new Error('Formato dati non valido');
    }
    
    updateStatus(`üç™ Trovati ${data.cookies.length} cookie - Preparazione...`, 'info');
    
    // Simula processo di preparazione
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    updateStatus('‚úÖ Cookie pronti per l\'iniezione!', 'success');
    
    // Mostra dettagli cookie
    showCookieDetails(data);
    
    // Messaggio importante per l'utente
    showImportantMessage();
    
    // Auto-redirect se presente URL
    if (data.url) {
        updateStatus('üöÄ Reindirizzamento automatico in 5 secondi...', 'info');
        
        // Countdown visivo
        let countdown = 5;
        const countdownInterval = setInterval(() => {
            countdown--;
            if (countdown > 0) {
                updateStatus(`üöÄ Reindirizzamento in ${countdown} secondi...`, 'info');
            } else {
                clearInterval(countdownInterval);
                updateStatus('üöÄ Reindirizzamento in corso...', 'info');
                window.location.href = data.url;
            }
        }, 1000);
    }
}

// Mostra dettagli cookie
function showCookieDetails(data) {
    const container = document.querySelector('.container') || document.body;
    
    const details = document.createElement('div');
    details.style.cssText = `
        max-width: 600px;
        margin: 20px auto;
        padding: 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.2);
    `;
    
    details.innerHTML = `
        <h3 style="color: #ffed4e; margin-bottom: 15px; text-align: center;">üìä Cookie Caricati</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div style="text-align: center; padding: 10px; background: rgba(40,167,69,0.2); border-radius: 8px;">
                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${data.cookies.length}</div>
                <div style="color: rgba(255,255,255,0.8);">Cookie Trovati</div>
            </div>
            <div style="text-align: center; padding: 10px; background: rgba(23,162,184,0.2); border-radius: 8px;">
                <div style="font-size: 14px; font-weight: bold; color: #17a2b8;">${data.source}</div>
                <div style="color: rgba(255,255,255,0.8);">Formato</div>
            </div>
        </div>
        
        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h4 style="color: #ffed4e; margin-bottom: 10px;">üç™ Cookie Principali:</h4>
            <ul style="margin: 0; padding-left: 20px; color: rgba(255,255,255,0.9);">
                ${data.cookies.slice(0, 5).map(cookie => {
                    const shortValue = cookie.value.length > 60 ? 
                        cookie.value.substring(0, 60) + '...' : 
                        cookie.value;
                    return `<li style="margin: 5px 0;"><strong>${cookie.name}</strong><br>
                           <small style="color: rgba(255,255,255,0.7);">${shortValue}</small></li>`;
                }).join('')}
                ${data.cookies.length > 5 ? `<li style="color: rgba(255,255,255,0.6);">... e altri ${data.cookies.length - 5} cookie</li>` : ''}
            </ul>
        </div>
        
        <div style="text-align: center; color: rgba(255,255,255,0.8); font-size: 12px;">
            Generato: ${new Date(data.timestamp).toLocaleString()}
        </div>
    `;
    
    container.appendChild(details);
}

// Messaggio importante per l'utente
function showImportantMessage() {
    const container = document.querySelector('.container') || document.body;
    
    const message = document.createElement('div');
    message.style.cssText = `
        max-width: 600px;
        margin: 20px auto;
        padding: 20px;
        background: rgba(255,193,7,0.2);
        border: 2px solid #ffc107;
        border-radius: 10px;
        text-align: center;
    `;
    
    message.innerHTML = `
        <h3 style="color: #ffc107; margin-bottom: 15px;">‚ö° Cookie Caricati con Successo!</h3>
        <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px; line-height: 1.6;">
            I cookie sono stati processati e saranno attivi quando verrai reindirizzato a Ticketone.
            Questo dovrebbe permetterti di <strong>bypassare la coda di attesa</strong>.
        </p>
        <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 15px;">
            Se il reindirizzamento automatico non funziona, clicca il pulsante qui sotto:
        </p>
        <button onclick="window.location.href='https://sport.ticketone.it'" 
                style="background: #28a745; color: white; border: none; padding: 12px 24px; 
                       border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold;">
            üé´ Vai a Ticketone
        </button>
    `;
    
    container.appendChild(message);
}

// Aggiorna status
function updateStatus(message, type = 'info') {
    console.log(`Status [${type}]: ${message}`);
    
    let statusEl = document.getElementById('status-message');
    if (!statusEl) {
        statusEl = document.createElement('div');
        statusEl.id = 'status-message';
        statusEl.style.cssText = `
            max-width: 600px;
            margin: 20px auto;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        `;
        
        const container = document.querySelector('.container') || document.body;
        container.insertBefore(statusEl, container.firstChild);
    }
    
    const colors = {
        'info': 'background: rgba(23, 162, 184, 0.2); color: #17a2b8; border: 1px solid #17a2b8;',
        'success': 'background: rgba(40, 167, 69, 0.2); color: #28a745; border: 1px solid #28a745;',
        'error': 'background: rgba(220, 53, 69, 0.2); color: #dc3545; border: 1px solid #dc3545;',
        'warning': 'background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid #ffc107;'
    };
    
    statusEl.style.cssText += colors[type] || colors.info;
    statusEl.textContent = message;
}

// Mostra istruzioni base
function showInstructions() {
    const container = document.querySelector('.container') || document.body;
    
    container.innerHTML += `
        <div style="margin: 30px auto; max-width: 600px; text-align: left;">
            <h3 style="color: #ffed4e;">üìñ Come Usare Hungry Tickets:</h3>
            <ol style="color: rgba(255,255,255,0.9); line-height: 1.8; font-size: 14px;">
                <li><strong>Installa l'estensione</strong> Hungry Tickets nel tuo browser</li>
                <li><strong>Vai su Ticketone</strong> e fai login con il tuo account</li>
                <li><strong>Naviga</strong> fino alla pagina dell'evento che ti interessa</li>
                <li><strong>Aspetta la coda</strong> (se presente) per catturare i cookie giusti</li>
                <li><strong>Apri l'estensione</strong> e clicca "Estrai Cookie"</li>
                <li><strong>Copia il link</strong> generato e invialo a chi vuoi</li>
                <li><strong>Chi riceve</strong> clicca il link e bypassa la coda!</li>
            </ol>
            
            <div style="margin-top: 20px; padding: 15px; background: rgba(23,162,184,0.1); border-radius: 8px; border-left: 4px solid #17a2b8;">
                <h4 style="color: #17a2b8; margin-bottom: 8px;">üí° Suggerimenti:</h4>
                <ul style="color: rgba(255,255,255,0.8); font-size: 13px; line-height: 1.6;">
                    <li>Estrai i cookie quando sei <strong>in coda o dopo il login</strong></li>
                    <li>I link micro funzionano <strong>su tutti i dispositivi</strong></li>
                    <li>Condividi subito il link, alcuni cookie hanno <strong>durata limitata</strong></li>
                    <li>Se non funziona, prova a <strong>rigenerare un nuovo link</strong></li>
                </ul>
            </div>
        </div>
    `;
}

// Mostra istruzioni di fallback
function showFallbackInstructions() {
    const container = document.querySelector('.container') || document.body;
    
    const fallback = document.createElement('div');
    fallback.style.cssText = `
        margin: 20px auto;
        max-width: 600px;
        padding: 20px;
        background: rgba(220,53,69,0.1);
        border: 2px solid #dc3545;
        border-radius: 10px;
    `;
    
    fallback.innerHTML = `
        <h4 style="color: #dc3545; margin-bottom: 15px; text-align: center;">üîß Link Non Funzionante</h4>
        <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px; text-align: center;">
            Il link potrebbe essere danneggiato, scaduto o in formato non supportato.
        </p>
        
        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h5 style="color: #ffc107; margin-bottom: 10px;">üõ†Ô∏è Soluzioni:</h5>
            <ul style="color: rgba(255,255,255,0.8); line-height: 1.6; font-size: 14px;">
                <li><strong>Link troncato:</strong> Assicurati che il link sia stato copiato completamente</li>
                <li><strong>Link scaduto:</strong> Chiedi di generare un nuovo link dall'estensione</li>
                <li><strong>Formato obsoleto:</strong> Usa la versione pi√π recente dell'estensione</li>
                <li><strong>Browser incompatibile:</strong> Prova con Chrome, Firefox o Safari</li>
            </ul>
        </div>
        
        <div style="text-align: center;">
            <button onclick="window.location.reload()" 
                    style="background: #17a2b8; color: white; border: none; padding: 10px 20px; 
                           border-radius: 6px; cursor: pointer; margin-right: 10px;">
                üîÑ Riprova
            </button>
            <button onclick="window.location.href='https://sport.ticketone.it'" 
                    style="background: #6c757d; color: white; border: none; padding: 10px 20px; 
                           border-radius: 6px; cursor: pointer;">
                üé´ Vai a Ticketone
            </button>
        </div>
    `;
    
    container.appendChild(fallback);
}

// Debug helper - mostra informazioni tecniche
function showDebugInfo(error) {
    if (window.location.search.includes('debug=1')) {
        const container = document.querySelector('.container') || document.body;
        
        const debug = document.createElement('div');
        debug.style.cssText = `
            margin: 20px auto;
            max-width: 600px;
            padding: 15px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #6c757d;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
        `;
        
        debug.innerHTML = `
            <h5 style="color: #ffc107;">üêõ Debug Info:</h5>
            <pre style="color: rgba(255,255,255,0.8); white-space: pre-wrap; margin: 0;">
URL: ${window.location.href}
Error: ${error ? error.message : 'N/A'}
User Agent: ${navigator.userAgent}
Timestamp: ${new Date().toISOString()}
            </pre>
        `;
        
        container.appendChild(debug);
    }
}
